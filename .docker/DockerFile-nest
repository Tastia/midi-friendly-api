FROM node:16-alpine3.15

ENV NODE_OPTIONS=--max_old_space_size=2048

ARG NODE_ENV=development
ENV NODE_ENV=${NODE_ENV}

RUN mkdir api

# files needed
COPY .env ./api
COPY ./package.json ./api
COPY ./nest-cli-worker.json ./api
COPY ./nest-cli.json ./api
COPY ./pnpm-lock.yaml ./api
COPY ./tsconfig.build.json ./api
COPY ./tsconfig.json ./api
COPY ./setup-emails.sh ./api

# folder needed
COPY ./src ./api/src
COPY ./emails ./api/emails
# COPY ./node_modules ./api/node_modules
# COPY ./.docker/run.sh ./api/
WORKDIR /api

RUN npm install 
RUN npm run build
RUN npm run emails

RUN npm run start:prod & run start:worker &

# RUN chmod u+r+x ./run.sh

# ENTRYPOINT ["tail", "-f", "/dev/null"]
# ENTRYPOINT ["npm", "run", "start:prod", "&", "npm", "run", "worker:prod", "&"]
